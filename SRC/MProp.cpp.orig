#include "_pch.h"
#include "MProp.h"

using namespace wh;


const std::vector<Field> gPropFieldVec = {
	{ "Èìÿ", FieldType::ftName, true },
	{ "Òèï", FieldType::ftText, true },
	{ "ID", FieldType::ftInt, true }
};



//-------------------------------------------------------------------------
//-------------------------------------------------------------------------
MProp::MProp(const char option)
:TModelData<rec::Prop>(option)
{

}
//-------------------------------------------------------------------------
bool MProp::GetSelectQuery(wxString& query)const
{
	const auto& prop = GetData();
	query = wxString::Format("SELECT id, label, type FROM t_prop WHERE id=%s", prop.mID);
	return true;
}
//-------------------------------------------------------------------------
bool MProp::GetInsertQuery(wxString& query)const
{
	const auto& prop = GetData();
	query = wxString::Format
		("INSERT INTO t_prop(label, type)VALUES('%s', %s)RETURNING id, label, type",
		prop.mLabel, prop.mType);
	return true;
}
//-------------------------------------------------------------------------
bool MProp::GetUpdateQuery(wxString& query)const
{
	const auto& prop = GetData();
	query = wxString::Format(
		"UPDATE t_prop SET label='%s', type=%s WHERE id=%s "
		, prop.mLabel, prop.mType, prop.mID);
	return true;
}
//-------------------------------------------------------------------------
bool MProp::GetDeleteQuery(wxString& query)const
{
	const auto& prop = GetData();
	query = wxString::Format("DELETE FROM t_prop WHERE id = %s", prop.mID);
	return true;
}
//-------------------------------------------------------------------------
bool MProp::LoadThisDataFromDb(std::shared_ptr<whTable>& table, const size_t row)
{
	T_Data data;
	table->GetAsString(0, row, data.mID);
	table->GetAsString(1, row, data.mLabel);
	table->GetAsString(2, row, data.mType);
	SetData(data);
	return true;
};
//-------------------------------------------------------------------------
bool MProp::GetFieldValue(unsigned int col, wxVariant &variant)
{
	auto mgr = ResMgr::GetInstance();

	const auto& data = this->GetData();

	switch (col)
	{
	default: break;
	case 1: variant = variant << wxDataViewIconText(data.mLabel, mgr->m_ico_classprop24);
		break;
	case 2: variant = data.GetTypeString(); break;
	case 3: variant = data.mID; break;
	}//switch(col) 
	mgr->FreeInst();
	return true;
}
//-------------------------------------------------------------------------
const std::vector<Field>& MProp::GetFieldVector()const
{
	return gPropFieldVec;
	//return gEmptyFieldVec;
}




//-------------------------------------------------------------------------
//-------------------------------------------------------------------------
MPropArray::MPropArray(const char option)
:IModel(option)
{
}
//-------------------------------------------------------------------------
bool MPropArray::GetSelectChildsQuery(wxString& query)const
{
	query = L"SELECT id, label, type FROM t_prop";
	return true;
}
//-------------------------------------------------------------------------
std::shared_ptr<IModel> MPropArray::CreateChild()
{
	auto child = new MProp;
	child->SetData(rec::Prop()); 
	return std::shared_ptr<IModel>(child);
}

//-------------------------------------------------------------------------
bool MPropArray::LoadChildDataFromDb(std::shared_ptr<IModel>& child, 
	std::shared_ptr<whTable>& table, const size_t pos)
{
	//auto propChild = std::dynamic_pointer_cast<MProp>(child);
	
	auto propChild = std::dynamic_pointer_cast<TModelData<rec::Prop>>(child);
	if (propChild)
		return propChild->LoadThisDataFromDb(table, pos);
	return false;
};
//-------------------------------------------------------------------------
const std::vector<Field>& MPropArray::GetFieldVector()const
{
	return gPropFieldVec;
	//return gEmptyFieldVec;
}

